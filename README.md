# PG-Bash Exporter

PG-Bash Exporter — это конфигурируемый экспортер для Prometheus, написанный на Go, который позволяет собирать кастомные метрики, выполняя любые shell-команды.

---

## Оглавление
- [Введение](#введение)
- [Ключевые особенности](#ключевые-особенности)
- [Установка](#установка)
- [Быстрый старт](#быстрый-старт)
- [Конфигурация](#конфигурация)
- [Использование](#использование)
- [Документация для пользователей](#документация-для-пользователей)
---

## Введение

Часто стандартных метрик (нагрузка на процессор, использование памяти) бывает недостаточно. Возникает необходимость следить за чем-то уникальным: например, количеством
активных пользователей в приложении, числом файлов в определённой папке или результатом работы специфической программы. Писать для каждой такой мелочи отдельный
экспортер — долго и неудобно. Этот инструмент решает эту проблему, позволяя описать все нужные метрики и команды для их получения в одном простом конфигурационном файле.

Он предназначен для DevOps-инженеров, системных администраторов и разработчиков, которые уже используют Prometheus и хотят расширить возможности своего мониторинга.
Проект идеально подходит для тех, кому нужна гибкость и скорость в добавлении новых метрик без необходимости писать код на Go.
```
+------------+      (1) Scrape      +------------------+      (2) Execute      +-----------------+
| Prometheus | -------------------> | PG-Bash Exporter | -------------------> | Shell / Scripts |
+------------+      (6) Metrics     +------------------+      (3) stdout      +-----------------+
               <------------------- |  (Cache + Parse) | <------------------- |
                                    +------------------+
```

## Ключевые особенности

*   **Невероятная гибкость:** Вы можете собирать любые метрики, какие только можно придумать. Если вы способны получить нужное значение с помощью команды в терминале (используя `grep`, `awk`, `curl` или любой другой инструмент), значит, вы можете превратить его в полноценную метрику для Prometheus.

*   **Простая и мощная конфигурация:** Все метрики настраиваются в одном YAML-файле, который легко читать и изменять. Экспортер умеет не только выполнять простые команды, но и разбирать вывод одной сложной команды на несколько разных показателей, а также создавать для них динамические метки (labels).

*   **Эффективность и забота о ресурсах:** Встроенное кэширование позволяет не запускать "тяжелые" скрипты слишком часто, что серьезно снижает нагрузку на сервер. Вы сами управляете тем, как часто обновлять данные для каждой конкретной метрики.

*   **Безопасность "из коробки":** Настраиваемый "черный список" помогает защититься от случайного выполнения опасных команд (вроде `rm` или `reboot`), делая использование экспортера более предсказуемым и безопасным.

*   **Обновление "на лету":** Конфигурацию можно перезагрузить без остановки самого экспортера. Это позволяет добавлять и изменять метрики без прерывания мониторинга.

## Установка

#### Скачивание готового файла (рекомендуемый способ)

Это самый простой способ начать работу. Мы предоставляем уже скомпилированные файлы для основных операционных систем.

1.  Перейдите на страницу [**Релизы**]() в репозитории проекта.
2.  Найдите самый свежий релиз.
3.  Скачайте архив, подходящий для вашей системы (например, `pg-bash-exporter-linux-amd64.tar.gz`).
4.  Распакуйте архив:
    ```sh
    tar -xvf pg-bash-exporter-linux-amd64.tar.gz
    ```
5.  Сделайте файл исполняемым:
    ```sh
    chmod +x pg-bash-exporter
    ```
6.  (Опционально) Переместите файл в директорию, которая есть в вашем `PATH`, чтобы запускать его из любого места:
    ```sh
    sudo mv pg-bash-exporter /usr/local/bin/
    ```

#### Сборка из исходного кода

Этот универсальный способ, который подойдет для любой операционной системы. Вам понадобится установленный **Go (версии 1.21 или новее)** и **Git**.

1.  **Клонируйте репозиторий:**
    ```sh
    git clone https://github.com/kvisidisi/pg-bash-exporter.git
    ```

2.  **Перейдите в папку проекта:**
    ```sh
    cd pg-bash-exporter
    ```

3.  **Соберите проект:**
    Эта команда скомпилирует экспортер в один исполняемый файл с именем `pg-bash-exporter`.
    ```sh
    go build -v -o pg-bash-exporter ./cmd/exporter
    ```

После выполнения этих шагов в папке проекта появится готовый к запуску файл `pg-bash-exporter`.


## Быстрый старт

Этот раздел поможет вам запустить экспортер за пару минут и убедиться, что все работает.

1.  **Создайте минимальный конфиг**

    Создайте файл с именем `config.yaml` и скопируйте в него этот текст. Это простейшая конфигурация, которая будет собирать всего одну метрику — время работы системы.

    ```yaml
    server:
        # Адрес, на котором будет работать экспортер
        listen_address: "0.0.0.0:9876"
        # Путь, по которому будут доступны метрики
        metrics_path: "/metrics"
        
    logging:
    # Logging level. Уровень логирования: "debug", "info", "error".
        level: "info"
    
    
    metrics:
    # Самая простая метрика для примера
    - name: "system_uptime_seconds"
      help: "Время работы системы в секундах."
      type: "counter"
      command: "cat /proc/uptime | awk '{print $1}'"
    ```

2.  **Запустите экспортер**

    Теперь запустите экспортер, указав путь к вашему новому файлу конфигурации. Если вы собирали его из исходников, файл `pg-bash-exporter` находится в папке проекта.

    ```sh
    ./pg-bash-exporter --config config.yaml
    ```
    Если все хорошо, вы не увидите ошибок в терминале. Экспортер запущен и ждет запросов.

3.  **Проверьте метрики**

    Откройте новый терминал и выполните команду `curl`. Она запросит метрики у вашего запущенного экспортера.

    ```sh
    curl http://localhost:9876/metrics
    ```

    В ответ вы должны увидеть что-то похожее на это (ваши цифры и некоторые другие метрики будут отличаться):

    ```text
    # ... другие служебные метрики самого экспортера ...
    
    # HELP system_uptime_seconds Время работы системы в секундах.
    # TYPE system_uptime_seconds counter
    system_uptime_seconds 35482.18
    ```
## Конфигурация

Вся настройка экспортера происходит в одном YAML-файле. Файл разделен на несколько логических секций:

*   `server`: Здесь вы указываете сетевые настройки — на каком порту и по какому адресу будет работать экспортер.
*   `logging`: Настройка логирования. Можно указать уровень детализации (`info`, `debug`, `error`) и куда сохранять логи.
*   `global`: Глобальные настройки, которые применяются ко всем метрикам по умолчанию. Например, общий таймаут для команд и время жизни кэша.
*   `metrics`: Самая главная секция. Это список всех ваших метрик. Здесь вы описываете каждую метрику: ее имя, команду для получения данных, тип и другие параметры.

Самый лучший способ понять все возможности конфигурации — это изучить подробный пример с комментариями.

**Полный пример конфигурационного файла со всеми доступными опциями и пояснениями можно найти здесь: [`configs/config.example.yaml`](./configs/config.example.yaml).**

## Использование

После того как экспортер запущен, вы можете управлять им с помощью флагов и системных сигналов.

#### Флаги командной строки

Это основные параметры, которые можно указать при запуске:

*   `--config <путь/к/файлу.yaml>`: Самый главный флаг. Указывает путь к вашему конфигурационному файлу.
    ```sh
    ./pg-bash-exporter --config /etc/pg-bash-exporter/config.yaml
    ```

*   `--validate-config`: Этот флаг не запускает экспортер, а только проверяет ваш конфигурационный файл на ошибки. Это очень удобно для проверки синтаксиса перед перезапуском сервиса.
    ```sh
    ./pg-bash-exporter --config config.yaml --validate-config
    # Вывод: Configuration is valid.
    ```
#### Перезагрузка конфигурации "на лету"

Вам не нужно перезапускать экспортер каждый раз, когда вы меняете конфиг. Вы можете плавно перезагрузить его, отправив процессу сигнал `SIGHUP`.

1.  **Найдите ID процесса (PID) экспортера:**
    ```sh
    pgrep -f pg-bash-exporter
    # Вывод: 12345
    ```

2.  **Отправьте сигнал:**
    ```sh
    kill -HUP 12345
    ```
    Экспортер получит сигнал, перечитает ваш `config.yaml` и применит изменения без остановки и потери метрик.

#### Интеграция с Prometheus

Чтобы Prometheus начал собирать метрики с вашего экспорtera, добавьте следующий блок в ваш файл `prometheus.yml` в секцию `scrape_configs`:

```yaml
- job_name: 'bash_exporter'
  static_configs:
    - targets: ['localhost:9876'] # Укажите здесь адрес вашего экспортера
```

*   `job_name`: Имя, под которым вы будете видеть метрики в Prometheus.
*   `targets`: Адрес и порт, которые вы указали в `listen_address` в вашем `config.yaml`.

После добавления этого блока и перезапуска Prometheus он начнет автоматически опрашивать ваш экспортер по адресу `/metrics`.

### Запуск полного стенда для разработки (Docker Compose)

Хотите увидеть, как экспортер работает в связке с настоящим Prometheus и Grafana? Мы подготовили все необходимое, чтобы вы могли запустить полный стенд одной командой.

**Что для этого нужно:**
Вам понадобится установленный и запущенный **Docker**.

**Как запустить:**

1.  Перейдите в директорию `demo` в корне проекта:
    ```sh
    cd demo
    ```

2.  Выполните команду:
    ```sh
    docker compose up --build -d
    ```
    Эта команда соберет образ для экспортера, скачает Prometheus и Grafana и запустит все три сервиса в фоновом режиме.

**Что вы получите:**

После запуска у вас будут работать три сервиса:
*   **Prometheus**: `http://localhost:9090`
*   **Grafana**: `http://localhost:3000` (логин/пароль: `admin`/`admin`)
*   **Ваш экспортер**: `http://localhost:8080`

Когда вы впервые зайдете в Grafana, вы увидите, что мы уже настроили для вас:
1.  **Источник данных Prometheus** — Grafana уже знает, где находится ваш Prometheus.
2.  **Готовый дашборд** с названием `Bash Exporter Metrics`, на котором отображаются основные метрики из вашего конфига и метрики здоровья самого экспортера.

**Как все остановить:**

Когда закончите, выполните эту команду в той же директории `demo`:
```sh
docker compose down
```
Она аккуратно остановит и удалит все контейнеры, созданные нашим стендом.

## Документация для пользователей

*   [**Решение проблем (TROUBLESHOOTING.md)**](./TROUBLESHOOTING.md) — Что делать, если что-то пошло не так.
*   [**Ограничения и краевые случаи (LIMITATIONS_RU.md)**](./LIMITATIONS_RU.md) — Чего экспортер не умеет делать и почему.
*   [**Зоны ответственности пользователя (USER_RESPONSIBILITIES.md)**](./USER_RESPONSIBILITIES.md) — За что отвечаете вы при настройке и использовании.