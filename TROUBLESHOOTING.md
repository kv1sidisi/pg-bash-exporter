### Руководство по решению проблем

Что-то пошло не так? Без паники. Давайте разберемся с самыми частыми проблемами.

#### 1. Экспортер вообще не запускается

**Симптом:** Вы запускаете экспортер, и он тут же падает с ошибкой `configuration is invalid`.

**Что делать:**
*   **Запустите проверку конфига.** Это самая полезная функция для отладки. Она не запустит сервер, а только проверит ваш `config.yaml` и укажет на ошибку.
    ```sh
    ./pg-bash-exporter --config config.yaml --validate-config
    ```
*   **Проверьте YAML-синтаксис.** Самая частая ошибка — неправильные отступы. В YAML они очень важны. Убедитесь, что все вложенные элементы сдвинуты вправо на два пробела.

#### 2. Метрика не появляется на странице `/metrics`

**Симптом:** Вы добавили новую метрику в конфиг, перезагрузили его, но на странице с метриками ее нет.

**Что делать:**
1.  **Посмотрите в логи.** Установите `logging.level: "debug"` в конфиге, чтобы видеть максимум информации. Скорее всего, вы увидите сообщение об ошибке для вашей метрики.
2.  **Выполните команду вручную.** Скопируйте команду из конфига и запустите ее в терминале. Посмотрите, что она выводит и с какой ошибкой завершается.
3.  **Проверьте права.** Запустите команду от имени того же пользователя, под которым работает экспортер (`sudo -u exporter <ваша_команда>`). Возможно, у него просто нет прав на выполнение вашего скрипта или чтение файла.
4.  **Проверьте вывод.** Команда может работать, но возвращать пустую строку или текст, который нельзя превратить в число. Экспортер пропустит такую метрику, но напишет об этом в лог.

#### 3. Prometheus не может получить метрики (ошибка `scrape timeout`)

**Симптом:** В интерфейсе Prometheus ваш экспортер помечен как "DOWN", а в логах ошибка `context deadline exceeded` или `scrape timeout`.

**Что делать:**
*   **Проблема:** Ваши команды в сумме работают дольше, чем таймаут сбора метрик в Prometheus (обычно 10-15 секунд).
*   **Быстрое решение:** Увеличьте `scrape_timeout` в `prometheus.yml` для этой задачи.
*   **Правильное решение:** Оптимизируйте ваши скрипты. Если какая-то команда действительно долгая, увеличьте `timeout` для нее в `config.yaml`, но убедитесь, что он все равно меньше, чем `scrape_timeout` в Prometheus. Используйте кэш (`cache_ttl`) для тяжелых команд.

#### 4. Ошибка `duplicate metrics` в Prometheus

**Симптом:** Prometheus жалуется на дубликаты метрик с одинаковыми именами и лейблами.

**Что делать:**
*   **Проблема:** Ваша команда возвращает несколько строк (например, `df` или `ls`), и экспортер пытается создать несколько метрик с одним и тем же именем и набором меток. Prometheus так не умеет.
*   **Решение:** Вам **обязательно** нужно использовать `dynamic_labels` в конфиге для этой метрики. Выберите колонку в выводе, которая уникальна для каждой строки (например, имя диска или пользователя), и сделайте из нее метку.

#### 5. Команда работает в терминале, но не в экспортере

**Симптом:** Вы копируете команду из конфига, запускаете ее в консоли — все отлично. А экспортер в логах пишет ошибку.

**Что делать:**
*   **Проблема №1: Переменная `PATH`.** У системного сервиса, от которого запущен экспортер, `PATH` может быть очень коротким. Он может просто не "видеть" утилиту, которую вы вызываете.
*   **Решение:** Всегда используйте **абсолютные пути** к командам в конфиге (например, `/usr/bin/grep` вместо `grep`).
*   **Проблема №2: Права доступа.** См. пункт 2.

#### 6. Изменения в конфиге не применяются

**Симптом:** Вы изменили `config.yaml`, но экспортер продолжает работать по-старому.

**Что делать:**
*   **Проблема:** Экспортер не знает, что вы изменили файл.
*   **Решение:** Отправьте ему сигнал `SIGHUP` для плавной перезагрузки. Найдите его PID (`pgrep pg-bash-exporter`) и выполните `kill -HUP <pid>`. Или просто перезапустите сервис (`systemctl reload pg-bash-exporter`).